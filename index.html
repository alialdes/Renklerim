<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Renklerim – Güneyler Elektrostatik</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#c1121f">
<style>
:root{--brand:#c1121f;--ink:#111;--muted:#666;--ring:#eaeaea;--radius:16px}
*{box-sizing:border-box} body{margin:0;font-family:system-ui,Roboto,Arial,sans-serif;background:#fff;color:var(--ink)}
.app{max-width:820px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column}
header{position:sticky;top:0;background:#fff;z-index:10;border-bottom:1px solid var(--ring);padding:.9rem 1rem;display:flex;align-items:center;gap:.7rem}
.logo{display:flex;align-items:center;gap:.6rem}
.logo-b{width:28px;height:28px;border-radius:8px;background:var(--brand);display:grid;place-items:center;color:#fff;font-weight:800}
.brand{font-weight:800} .sub{color:var(--brand);font-weight:600;font-size:.9rem}
.search{display:flex;gap:.5rem;padding:.75rem 1rem;border-bottom:1px solid var(--ring)}
.search input{flex:1;border:1px solid var(--ring);border-radius:999px;padding:.7rem 1rem}
.search button{border:none;background:var(--brand);color:#fff;border-radius:999px;padding:.7rem 1rem;font-weight:700}
main{flex:1;padding:1rem}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
@media(min-width:560px){ .grid{grid-template-columns:repeat(3,1fr)} }
.tile{border:1px solid var(--ring);border-radius:var(--radius);overflow:hidden;background:#fafafa;cursor:pointer}
.swatch{height:90px}
.tile-body{padding:.6rem}
.code{font-weight:800}.name{font-size:.9rem;color:var(--muted)}
.toolbar{display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem}
.btn{border:1px solid var(--ring);border-radius:10px;background:#fff;padding:.4rem .7rem}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.camera{display:grid;gap:.75rem}
video,canvas{width:100%;border-radius:14px;border:1px solid var(--ring);background:#000}
.hint{color:var(--muted);font-size:.9rem}
dialog{border:none;border-radius:18px;max-width:560px;width:clamp(280px,92vw,560px);padding:0;overflow:hidden}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:.9rem 1rem;border-bottom:1px solid var(--ring)}
.modal-body{padding:1rem}
.big{height:150px;border:1px solid var(--ring);border-radius:12px}
.kv{display:grid;grid-template-columns:120px 1fr;gap:.5rem .75rem;margin-top:.8rem}
.key{color:var(--muted)}
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:.6rem .9rem;border-radius:999px;opacity:0;transition:.3s;z-index:50}
.toast.show{opacity:1}
.tabs{display:flex;gap:.5rem;padding:.5rem 1rem;border-bottom:1px solid var(--ring)}
.tab{flex:1;padding:.6rem;border-radius:999px;border:1px solid var(--ring);background:#fff}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.empty{padding:1rem;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">
      <div class="logo-b">G</div>
      <div>
        <div class="brand">Güneyler Elektrostatik</div>
        <div class="sub">Renklerim</div>
      </div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" data-tab="categories">Kategoriler</button>
    <button class="tab" data-tab="favorites">Favoriler</button>
    <button class="tab" data-tab="camera">Kamera</button>
  </div>

  <div class="search">
    <input id="q" placeholder="Ara: RAL no veya isim">
    <button id="clear">Temizle</button>
  </div>

  <main id="content"></main>

  <dialog id="dlg">
    <div class="modal-head">
      <strong id="dlgTitle">RAL</strong>
      <button class="btn" onclick="dlg.close()">Kapat</button>
    </div>
    <div class="modal-body">
      <div id="dlgSwatch" class="big"></div>
      <div class="kv">
        <div class="key">RAL</div><div id="dlgCode">-</div>
        <div class="key">Ad</div><div id="dlgName">-</div>
        <div class="key">HEX</div>
        <div><span id="dlgHex">-</span> <button class="btn" onclick="copyHex()">Kopyala</button></div>
        <div class="key">RGB</div><div id="dlgRgb">-</div>
        <div class="key">İşlem</div>
        <div><button id="favBtn" class="btn primary">Favoriye Ekle</button></div>
      </div>
    </div>
  </dialog>

  <div id="toast" class="toast">Kopyalandı</div>
</div>

<script>
// Tabs
let activeTab='categories'; let activeCategory=null; let query='';
const content=document.getElementById('content');
document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));b.classList.add('active');activeTab=b.dataset.tab;activeCategory=null;render();});
document.getElementById('q').addEventListener('input',e=>{query=e.target.value.toLowerCase();render();});
document.getElementById('clear').onclick=()=>{document.getElementById('q').value='';query='';render();};

// Storage
const store={d:'ralData',f:'ralFavs', get(){try{return JSON.parse(localStorage.getItem(this.d))||null}catch{return null}}, set(v){localStorage.setItem(this.d,JSON.stringify(v))}, getFav(){try{return JSON.parse(localStorage.getItem(this.f))||[]}catch{return []}}, setFav(v){localStorage.setItem(this.f,JSON.stringify(v))}};
let DATA = store.get() || [];
let FAVS = store.getFav();

// Load data
fetch('ral_colors.json').then(r=>r.json()).then(j=>{ if(!DATA.length){ DATA=j; store.set(DATA);} render(); });

const CATS=[
 {series:'1000',name:'Sarılar'},{series:'2000',name:'Turuncular'},{series:'3000',name:'Kırmızılar'},
 {series:'4000',name:'Morlar'},{series:'5000',name:'Maviler'},{series:'6000',name:'Yeşiller'},
 {series:'7000',name:'Griler'},{series:'8000',name:'Kahverengiler'},{series:'9000',name:'Beyaz & Siyah'}
];

function render(){
  if(activeTab==='categories') return renderCategories();
  if(activeTab==='favorites') return renderFavorites();
  if(activeTab==='camera') return renderCamera();
}

function filtered(list){
  if(!query) return list;
  return list.filter(x=> (x.code+' '+x.name).toLowerCase().includes(query));
}

function renderCategories(){
  if(!activeCategory){
    const grid = CATS.map(c=>`
      <div class="tile" onclick='openCategory("${c.series}")'>
        <div class="swatch" style="background:#f2f2f2;display:flex;align-items:center;justify-content:center;font-weight:800">${c.series}</div>
        <div class="tile-body"><div class="code">${c.name}</div><div class="name">${c.series} serisi</div></div>
      </div>`).join('');
    content.innerHTML = `<div class="grid">${grid}</div>`;
  }else{
    const all = DATA.filter(x=>x.code.startsWith('RAL '+activeCategory));
    const list=filtered(all);
    content.innerHTML = `
      <div class="toolbar">
        <button class="btn" onclick="activeCategory=null;render()">← Geri</button>
        <div class="name">${activeCategory} serisi • ${all.length} renk</div>
      </div>
      <div class="grid">${list.map(card).join('')}</div>`;
  }
}
function openCategory(s){ activeCategory=s; renderCategories(); }

function card(it){
  return `<div class="tile" onclick='openDetail(${JSON.stringify(it)})'>
    <div class="swatch" style="background:${it.hex}"></div>
    <div class="tile-body">
      <div class="code">${it.code}</div>
      <div class="name">${it.name} • ${it.hex.toUpperCase()}</div>
    </div>
  </div>`;
}

function renderFavorites(){
  const favs = DATA.filter(x=>FAVS.includes(x.code));
  const list = filtered(favs);
  if(!list.length) { content.innerHTML = '<div class="empty">Henüz favori yok.</div>'; return; }
  content.innerHTML = `<div class="grid">${list.map(card).join('')}</div>`;
}

// Detail dialog
const dlg = document.getElementById('dlg');
function openDetail(it){
  document.getElementById('dlgTitle').textContent = it.code;
  document.getElementById('dlgSwatch').style.background = it.hex;
  document.getElementById('dlgCode').textContent = it.code;
  document.getElementById('dlgName').textContent = it.name;
  document.getElementById('dlgHex').textContent = it.hex.toUpperCase();
  const rgb = hexToRgb(it.hex); document.getElementById('dlgRgb').textContent = `${rgb.r}, ${rgb.g}, ${rgb.b}`;
  const btn = document.getElementById('favBtn');
  btn.textContent = FAVS.includes(it.code)?'Favoriden Çıkar':'Favoriye Ekle';
  btn.onclick = ()=>{ toggleFav(it.code); openDetail(it); };
  dlg.showModal();
}
function copyHex(){ const h=document.getElementById('dlgHex').textContent; navigator.clipboard?.writeText(h); toast('HEX kopyalandı'); }

function toggleFav(code){
  const i = FAVS.indexOf(code);
  if(i>-1) FAVS.splice(i,1); else FAVS.push(code);
  store.setFav(FAVS); render();
}

// Camera
let stream=null, videoEl=null, canvasEl=null, ctx=null;
function renderCamera(){
  content.innerHTML = `
    <div class="camera">
      <video id="video" playsinline muted></video>
      <canvas id="canvas" height="0"></canvas>
      <div class="toolbar">
        <button class="btn primary" onclick="startCam()">Kamerayı Başlat</button>
        <button class="btn" onclick="stopCam()">Durdur</button>
      </div>
      <div class="hint">Videoya dokun: piksel rengi alınır ve en yakın RAL bulunur.</div>
      <div id="match"></div>
    </div>`;
  videoEl = document.getElementById('video');
  canvasEl = document.getElementById('canvas');
}
async function startCam(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    videoEl.srcObject = stream; await videoEl.play();
    resizeCanvas(); videoEl.addEventListener('click', pickColor);
    window.addEventListener('resize', resizeCanvas); toast('Kamera hazır');
  }catch(e){ alert('Kamera reddedildi veya desteklenmiyor.'); }
}
function stopCam(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } videoEl?.pause?.(); toast('Kamera durdu'); }
function resizeCanvas(){ canvasEl.width=videoEl.videoWidth||videoEl.clientWidth; canvasEl.height=videoEl.videoHeight||videoEl.clientHeight; ctx=canvasEl.getContext('2d'); }
function pickColor(ev){
  if(!ctx) return; ctx.drawImage(videoEl,0,0,canvasEl.width,canvasEl.height);
  const r = videoEl.getBoundingClientRect();
  const x = Math.round((ev.clientX-r.left)*(canvasEl.width/r.width));
  const y = Math.round((ev.clientY-r.top)*(canvasEl.height/r.height));
  const p = ctx.getImageData(x,y,1,1).data; const hex = rgbToHex(p[0],p[1],p[2]);
  const best = nearestRAL(hex);
  const el = document.getElementById('match');
  if(!best){ el.innerHTML='<div class="empty">Eşleşme yok</div>'; return; }
  el.innerHTML = `<div class="tile">
    <div class="swatch" style="background:${hex}"></div>
    <div class="tile-body"><div class="name">Seçilen: <b>${hex.toUpperCase()}</b></div></div>
  </div>
  <div class="tile" style="margin-top:.6rem">
    <div class="swatch" style="background:${best.hex}"></div>
    <div class="tile-body">
      <div class="code">${best.code}</div>
      <div class="name">${best.name} • ${best.hex.toUpperCase()}</div>
      <div class="toolbar"><span class="hint">Yakınlık: ${best._dist}</span><button class="btn" onclick='openDetail(${JSON.stringify(best)})'>Detay</button></div>
    </div>
  </div>`;
}

// Utils
function hexToRgb(h){const s=h.replace('#','');const n=parseInt(s,16);return{r:(n>>16)&255,g:(n>>8)&255,b:n&255};}
function rgbToHex(r,g,b){return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');}
function distRGB(h1,h2){const a=hexToRgb(h1),b=hexToRgb(h2);const dx=a.r-b.r,dy=a.g-b.g,dz=a.b-b.b;return Math.round(Math.sqrt(dx*dx+dy*dy+dz*dz));}
function nearestRAL(hex){ let best=null,d=1e9; for(const it of DATA){ const dd=distRGB(hex,it.hex); if(dd<d){d=dd; best=Object.assign({_dist:dd},it);} } return best; }
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1200);}

// PWA: register SW
if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('sw.js'); }); }

// initial
render();
</script>
</body>
</html>